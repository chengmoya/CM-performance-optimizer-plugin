# CM 性能优化插件

[![Version](https://img.shields.io/badge/version-4.2.0-blue.svg)]()
[![License](https://img.shields.io/badge/license-GPL--3.0-green.svg)](LICENSE)
[![MaiBot](https://img.shields.io/badge/MaiBot-0.12.2+-green.svg)]()

通过缓存数据库查询结果来优化 MaiBot 性能，减少数据库 IO 开销。包含消息缓存、人物信息缓存、表达式缓存、黑话缓存、知识库图谱缓存和预加载六个模块，可减少95%以上的数据库查询，显著降低响应延迟。

## 功能特性

### 消息缓存
- **原理**: 拦截 `find_messages` 数据库查询，相同参数直接返回缓存结果
- **效果**: 命中率通常 >95%，可节省约 95% 的消息查询时间
- **适用场景**: 频繁查询相同聊天记录的场景

### 人物信息缓存
- **原理**: 拦截人物信息加载，按 QQ号 缓存昵称等信息
- **效果**: 命中率通常 >90%，减少人物信息的重复查询
- **适用场景**: 频繁获取人物信息的场景

### 表达式缓存
- **原理**: 双缓冲 + 缓慢加载 + 原子切换，全量缓存表达式数据
- **效果**: 启动后约 10 秒完成加载，后续查询直接从内存读取
- **适用场景**: 表达式学习、相似度匹配等场景
- **内存占用**: 2 万条约 25-65 MB

### 黑话缓存
- **原理**: 双缓冲 + 缓慢加载 + 原子切换 + 内容索引，O(1) 查找
- **效果**: 启动后约 10 秒完成加载，黑话匹配速度提升 100 倍以上
- **适用场景**: 黑话解释、网络用语识别等场景
- **内存占用**: 2 万条约 15-45 MB

### 知识库图谱缓存
- **原理**: 双缓冲 + 缓慢加载 + 原子切换，全量缓存知识库图谱数据
- **效果**: 启动后约 5-10 秒完成加载，知识库查询速度提升 80-90%，消除文件 IO 开销
- **适用场景**: LPMM 知识库查询、RAG 检索等场景
- **内存占用**: 1000 实体 + 5000 段落约 1-10 MB

### 预加载
- **原理**: 当聊天流激活时，异步预加载最近消息和人物信息到缓存
- **效果**: 首次查询性能提升 90% 以上，减少冷启动延迟
- **适用场景**: 频繁切换聊天流的场景
- **内存占用**: 根据配置的聊天流数量和消息数量动态调整

## 性能指标

| 指标 | 数值 |
|------|------|
| 基础内存占用 | 约 10-20 MB |
| 表达式缓存 (2万条) | 约 25-65 MB |
| 黑话缓存 (2万条) | 约 15-45 MB |
| 知识库图谱缓存 | 约 1-10 MB |
| CPU 开销 | 极低 (缓慢加载) |
| 消息缓存命中率 | >95% |
| 人物缓存命中率 | >90% |
| 知识库图谱缓存命中率 | >85% |
| 平均节省时间 | 40-50 ms/次查询 |
| 表达式加载时间 | 约 10 秒 (2万条) |
| 黑话加载时间 | 约 10 秒 (2万条) |
| 知识库图谱加载时间 | 约 5-10 秒 |

## 安装

将插件目录放入 `MaiBot/plugins/` 下，重启 MaiBot 即可。

### 依赖

- **MaiBot**: 0.12.2+
- **Python**: 3.9+
- **额外依赖**: 无

## 配置

### WebUI 配置

插件支持 WebUI 可视化配置，提供 8 个标签页：

1. **插件** - 基础设置、日志等级
2. **模块开关** - 启用/禁用各缓存模块
3. **消息缓存** - 缓存大小、过期时间
4. **人物信息缓存** - 缓存大小、过期时间
5. **表达式缓存** - 批次大小、延迟、刷新间隔
6. **黑话缓存** - 批次大小、延迟、刷新间隔、内容索引
7. **知识库图谱缓存** - 批次大小、延迟、刷新间隔
8. **预加载** - 聊天流数量、消息数量、人物数量、预加载延迟

### 配置文件

配置文件位于 `config.toml`：

```toml
[plugin]
enabled = true          # 是否启用插件
report_interval = 60    # 统计报告间隔(秒)，设置0可关闭
log_level = "INFO"      # 日志等级: DEBUG/INFO/WARNING/ERROR

[modules]
message_cache_enabled = true    # 消息缓存
person_cache_enabled = true     # 人物信息缓存
expression_cache_enabled = false # 表达式缓存
slang_cache_enabled = false      # 黑话缓存
kg_cache_enabled = false         # 知识库图谱缓存

[message_cache]
max_size = 2000         # 缓存最大条目数 (约2-10MB内存)
ttl = 120.0             # 缓存过期时间(秒)

[person_cache]
max_size = 3000         # 缓存最大条目数 (约1.5-6MB内存)
ttl = 1800              # 缓存过期时间(秒) 30分钟

[expression_cache]
batch_size = 100        # 每批加载条数
batch_delay = 0.05      # 批次间延迟(秒)
refresh_interval = 3600 # 自动刷新间隔(秒)，0=不自动刷新

[slang_cache]
batch_size = 100        # 每批加载条数
batch_delay = 0.05      # 批次间延迟(秒)
refresh_interval = 3600 # 自动刷新间隔(秒)，0=不自动刷新
enable_content_index = true  # 启用内容索引，O(1)查找

[kg_cache]
batch_size = 100        # 每批加载条数
batch_delay = 0.05      # 批次间延迟(秒)
refresh_interval = 3600 # 自动刷新间隔(秒)，0=不自动刷新

[preload]
max_streams = 10        # 最多预加载的聊天流数量
message_count = 50      # 每个聊天流预加载的消息数量
max_persons_per_stream = 50  # 每个聊天流预加载的最大人物数量
preload_delay = 0.1     # 预加载延迟(秒)
```

### 配置说明

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `plugin.enabled` | true | 是否启用插件 |
| `plugin.report_interval` | 60 | 统计报告间隔(秒)，0=关闭 |
| `plugin.log_level` | INFO | 日志等级 |
| `message_cache.max_size` | 2000 | 消息缓存条目数上限 |
| `message_cache.ttl` | 120 | 消息缓存过期时间(秒) |
| `person_cache.max_size` | 3000 | 人物缓存条目数上限 |
| `person_cache.ttl` | 1800 | 人物缓存过期时间(秒) |
| `expression_cache.batch_size` | 100 | 每批加载条数，2万条约需10秒 |
| `expression_cache.batch_delay` | 0.05 | 批次间延迟(秒)，用于平滑加载 |
| `expression_cache.refresh_interval` | 3600 | 自动刷新间隔(秒)，0=不自动刷新 |
| `slang_cache.batch_size` | 100 | 每批加载条数，2万条约需10秒 |
| `slang_cache.batch_delay` | 0.05 | 批次间延迟(秒)，用于平滑加载 |
| `slang_cache.refresh_interval` | 3600 | 自动刷新间隔(秒)，0=不自动刷新 |
| `slang_cache.enable_content_index` | true | 启用内容索引，O(1)查找速度 |
| `kg_cache.batch_size` | 100 | 每批加载条数 |
| `kg_cache.batch_delay` | 0.05 | 批次间延迟(秒)，用于平滑加载 |
| `kg_cache.refresh_interval` | 3600 | 自动刷新间隔(秒)，0=不自动刷新 |
| `preload.max_streams` | 10 | 最多预加载的聊天流数量 |
| `preload.message_count` | 50 | 每个聊天流预加载的消息数量 |
| `preload.max_persons_per_stream` | 50 | 每个聊天流预加载的最大人物数量 |
| `preload.preload_delay` | 0.1 | 预加载延迟(秒) |

## 统计报告

插件会定期输出统计报告 (默认60秒)：

```
[PerfOpt] 📊 性能统计报告 | 运行时间: 0h42m56s
------------------------------------------------------------
[PerfOpt] 📦 消息缓存 | 缓存大小: 248/2000
[PerfOpt]   累计: 命中 151356 | 未命中 3446 | 命中率 97.8%
[PerfOpt]   💡 节省约 6985.8s 数据库查询时间 (平均 46.2ms/次)
------------------------------------------------------------
[PerfOpt] 👤 人物缓存 | 缓存大小: 156/3000
[PerfOpt]   累计: 命中 8234 | 未命中 892 | 命中率 90.2%
------------------------------------------------------------
[PerfOpt] 🎭 表达式缓存 | 状态: 已加载 | 大小: 21543 条
[PerfOpt]   上次刷新: 25m30s前
[PerfOpt]   自动刷新间隔: 3600秒
------------------------------------------------------------
[PerfOpt] 🗣️ 黑话缓存 | 状态: 已加载 | 大小: 18765 条
[PerfOpt]   上次刷新: 25m30s前
[PerfOpt]   自动刷新间隔: 3600秒
------------------------------------------------------------
[PerfOpt] 🧠 知识库图谱缓存 | 状态: 已加载 | 大小: 节点5234个, 边18765条, 实体1234个, 段落4000个
[PerfOpt]   上次刷新: 15m20s前
[PerfOpt]   自动刷新间隔: 3600秒
[PerfOpt]   累计: 命中 456 | 未命中 23 | 命中率 95.2%
[PerfOpt]   💡 节省约 234.5s 文件加载时间 (平均 514.3ms/次)
```

## 故障排除

### 插件无法加载
1. 检查 `_manifest.json` 文件是否存在且格式正确
2. 检查 Python 版本 >= 3.9
3. 查看 MaiBot 日志中的错误信息

### 日志等级修改无效
日志等级需要重启 MaiBot 后生效。

### 缓存命中率低
1. 检查 TTL 设置是否过短
2. 检查 max_size 是否过小

## 更新日志

### v4.2.0
- 新增知识库图谱缓存模块（双缓冲 + 缓慢加载 + 原子切换）
- 知识库查询速度提升 80-90%，消除文件 IO 开销
- 添加知识库图谱缓存统计报告
- 新增 WebUI 配置标签页（知识库图谱缓存）
- 插件版本更新至 v4.2.0

### v4.1.0
- 新增预加载模块（异步预加载聊天流的消息和人物信息）
- 修复表达式缓存拦截方法引用bug
- 修复黑话缓存拦截方法引用bug
- 优化统计报告日志格式，避免对齐问题
- 小数配置项改为下拉框选择（batch_delay、preload_delay）
- 添加表达式和黑话缓存的命中统计
- 添加节省时间统计

### v4.0.0
- 新增表达式缓存模块（双缓冲 + 缓慢加载 + 原子切换）
- 新增黑话缓存模块（双缓冲 + 缓慢加载 + 原子切换 + 内容索引）
- 支持全量缓存预热，启动后约 10 秒完成加载
- 支持自动刷新和手动刷新
- 添加 2 个新的 WebUI 配置标签页

### v3.0.0
- 整合人物信息缓存功能
- 添加模块化配置
- 添加 WebUI 标签页布局
- 添加日志等级配置

### v2.x
- 消息缓存功能
- 定时统计报告

## 许可证

GPL-3.0
