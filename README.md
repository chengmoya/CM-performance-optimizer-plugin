# CM 性能优化插件

[![Version](https://img.shields.io/badge/version-3.0.0-blue.svg)]()
[![License](https://img.shields.io/badge/license-GPL--3.0-green.svg)](LICENSE)
[![MaiBot](https://img.shields.io/badge/MaiBot-0.11.0+-green.svg)]()

通过缓存数据库查询结果来优化 MaiBot 性能，减少数据库 IO 开销。

## 功能特性

### 消息缓存
- **原理**: 拦截 `find_messages` 数据库查询，相同参数直接返回缓存结果
- **效果**: 命中率通常 >95%，可节省约 95% 的消息查询时间
- **适用场景**: 频繁查询相同聊天记录的场景

### 人物信息缓存
- **原理**: 拦截人物信息加载，按 QQ号 缓存昵称等信息
- **效果**: 命中率通常 >90%，减少人物信息的重复查询
- **适用场景**: 频繁获取人物信息的场景

### 预留模块 (开发中)
- 表达式缓存
- 黑话缓存

## 性能指标

| 指标 | 数值 |
|------|------|
| 内存占用 | 约 10-20 MB |
| CPU 开销 | 极低 |
| 消息缓存命中率 | >95% |
| 人物缓存命中率 | >90% |
| 平均节省时间 | 40-50 ms/次查询 |

## 安装

将插件目录放入 `MaiBot/plugins/` 下，重启 MaiBot 即可。

### 依赖

- **MaiBot**: 0.11.0+
- **Python**: 3.9+
- **额外依赖**: 无

## 配置

### WebUI 配置

插件支持 WebUI 可视化配置，提供 4 个标签页：

1. **插件** - 基础设置、日志等级
2. **模块开关** - 启用/禁用各缓存模块
3. **消息缓存** - 缓存大小、过期时间
4. **人物信息缓存** - 缓存大小、过期时间

### 配置文件

配置文件位于 `config.toml`：

```toml
[plugin]
enabled = true          # 是否启用插件
report_interval = 60    # 统计报告间隔(秒)，设置0可关闭
log_level = "INFO"      # 日志等级: DEBUG/INFO/WARNING/ERROR

[modules]
message_cache_enabled = true    # 消息缓存
person_cache_enabled = true     # 人物信息缓存

[message_cache]
max_size = 2000         # 缓存最大条目数 (约2-10MB内存)
ttl = 120.0             # 缓存过期时间(秒)

[person_cache]
max_size = 3000         # 缓存最大条目数 (约1.5-6MB内存)
ttl = 1800              # 缓存过期时间(秒) 30分钟
```

### 配置说明

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `plugin.enabled` | true | 是否启用插件 |
| `plugin.report_interval` | 60 | 统计报告间隔(秒)，0=关闭 |
| `plugin.log_level` | INFO | 日志等级 |
| `message_cache.max_size` | 2000 | 消息缓存条目数上限 |
| `message_cache.ttl` | 120 | 消息缓存过期时间(秒) |
| `person_cache.max_size` | 3000 | 人物缓存条目数上限 |
| `person_cache.ttl` | 1800 | 人物缓存过期时间(秒) |

## 统计报告

插件会定期输出统计报告 (默认60秒)：

```
[PerfOpt] 📊 性能统计报告 | 运行时间: 0h42m56s
------------------------------------------------------------
[PerfOpt] 📦 消息缓存 | 缓存大小: 248/2000
[PerfOpt]   累计: 命中 151356 | 未命中 3446 | 命中率 97.8%
[PerfOpt]   💡 节省约 6985.8s 数据库查询时间 (平均 46.2ms/次)
------------------------------------------------------------
[PerfOpt] 👤 人物缓存 | 缓存大小: 156/3000
[PerfOpt]   累计: 命中 8234 | 未命中 892 | 命中率 90.2%
```

## 故障排除

### 插件无法加载
1. 检查 `_manifest.json` 文件是否存在且格式正确
2. 检查 Python 版本 >= 3.9
3. 查看 MaiBot 日志中的错误信息

### 日志等级修改无效
日志等级需要重启 MaiBot 后生效。

### 缓存命中率低
1. 检查 TTL 设置是否过短
2. 检查 max_size 是否过小

## 更新日志

### v3.0.0
- 整合人物信息缓存功能
- 添加模块化配置
- 添加 WebUI 标签页布局
- 添加日志等级配置

### v2.x
- 消息缓存功能
- 定时统计报告

## 许可证

GPL-3.0
